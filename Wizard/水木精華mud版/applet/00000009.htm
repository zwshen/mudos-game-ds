<HTML>
<HEAD>
<TITLE>BBS水木清华站∶精华区</TITLE>
</HEAD>
<BODY>
<CENTER><H1>BBS水木清华站∶精华区</H1></CENTER>
<A Name="top"></a>
发信人:&nbsp;sadsong&nbsp;(烛光泪影),&nbsp;信区:&nbsp;Mud_Builder&nbsp;<BR>
标&nbsp;&nbsp;题:&nbsp;类似bbs留言板的实现&nbsp;<BR>
发信站:&nbsp;BBS&nbsp;水木清华站&nbsp;(Thu&nbsp;Dec&nbsp;25&nbsp;12:55:51&nbsp;1997)&nbsp;<BR>
&nbsp;<BR>
&nbsp;<BR>
&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;留言板功能，在Mud中的board中已经有了很好的实现，其中使用的是&nbsp;<BR>
.o格式通过mapping访问的数据文件，许多留言都被存成了一个文件，&nbsp;<BR>
那种格式和玩家的数据格式是一样的。&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;玩家可以通过模拟现实世界进行留言，但是访问起来很是麻烦，留言的实时性&nbsp;<BR>
不够好，若能加入类似bbs&nbsp;quit时留言，新上线就能看到的会满足此要求，我根据这&nbsp;<BR>
样的设想加入了此功能。&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;我的留言板是这样设计的：&nbsp;<BR>
1)&nbsp;<BR>
玩家在quit时，提供了4种选择：不留言，给玩家，给巫师，返回世界&nbsp;<BR>
2)&nbsp;<BR>
玩家在新上线时能看到自己的留言以及新的留言。&nbsp;<BR>
3)&nbsp;<BR>
文件的存取方式是存成许多文件，而不是一个。&nbsp;<BR>
&nbsp;<BR>
由于系统在发呆时间过长，或者键入相通的命令过多会简单的command(&quot;quit&quot;)，&nbsp;<BR>
而在新的改动中会总在那里等待玩家选择，所以相应的程序需要改动。&nbsp;<BR>
当然若把quit.c改成可以等待一段时间，如果玩家还没有选择就退出那会更好，&nbsp;<BR>
alias.c中避免输入相同命令的判断还是有问题，不过玩家的输入是没有反应的，&nbsp;<BR>
可以不管这种效果，这样就不需要改动那几个系统文件了。&nbsp;<BR>
&nbsp;<BR>
下面就把所有的相关代码说明一下。&nbsp;<BR>
&nbsp;<BR>
////////////////////////////////////////////////////////////////////////////////////////////&nbsp;<BR>
//1997.11.26&nbsp;by&nbsp;maxim@nju_fengxue&nbsp;<BR>
///////////////////////////////////////////////////////////////////////////////////////////&nbsp;<BR>
&nbsp;<BR>
1)&nbsp;<BR>
/cmds/usr/quit.c的改动：&nbsp;<BR>
在主程序main()结束之前加入：&nbsp;<BR>
&nbsp;<BR>
m_display();&nbsp;<BR>
write(YEL&quot;你现在的打算：&quot;NOR);&nbsp;<BR>
input_to(&nbsp;(:&nbsp;confirm_main_choice&nbsp;:),&nbsp;this_player()&nbsp;);&nbsp;<BR>
return&nbsp;1;&nbsp;<BR>
}&nbsp;<BR>
&nbsp;<BR>
以下是所用到的函数定义：&nbsp;<BR>
private&nbsp;void&nbsp;m_display()&nbsp;<BR>
{&nbsp;<BR>
write(HBRED&quot;------------------------------&quot;NOR);&nbsp;<BR>
write(&quot;\n&quot;);&nbsp;<BR>
write(HBRED&quot;|&quot;NOR);&nbsp;<BR>
write(HBBLU+HIR&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1.玩家留言&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;HBRED&quot;|&quot;NOR&quot;\n&quot;);&nbsp;<BR>
write(HBRED&quot;|&quot;NOR);&nbsp;<BR>
write(HBBLU+YEL&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2.不留言&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;HBRED&quot;|&quot;NOR&quot;\n&quot;);&nbsp;<BR>
write(HBRED&quot;|&quot;NOR);&nbsp;<BR>
write(HBBLU+MAG&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.留言给巫师&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;HBRED&quot;|&quot;NOR&quot;\n&quot;);&nbsp;<BR>
write(HBRED&quot;|&quot;NOR);&nbsp;<BR>
write(HBBLU+HIW&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.打错了,我还想玩呢&nbsp;&nbsp;&quot;HBRED&quot;|&quot;NOR&quot;\n&quot;);&nbsp;<BR>
write(HBRED&quot;|&quot;NOR);&nbsp;<BR>
write(HBRED&quot;-----------------------------&quot;NOR);&nbsp;<BR>
write(&quot;\n&quot;);&nbsp;<BR>
write(&quot;\n&quot;);&nbsp;<BR>
}&nbsp;<BR>
//类似&nbsp;board留言板的程序：&nbsp;<BR>
&nbsp;<BR>
void&nbsp;done_write(object&nbsp;me,&nbsp;&nbsp;string&nbsp;text)&nbsp;<BR>
{&nbsp;<BR>
if(sizeof(text)&nbsp;&lt;&nbsp;4)&nbsp;{&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;write(&quot;你的留言由于太简单而被自动取消,别人将无法看到.\n&quot;);&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;QUIT_D-&gt;leave_world(me);&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<BR>
write_file(BBSLEAVE_DIR+(string)(spe_filenum),&nbsp;text);&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;QUIT_D-&gt;leave_world(me);&nbsp;<BR>
&nbsp;return;&nbsp;<BR>
}&nbsp;<BR>
void&nbsp;done_write_towiz(object&nbsp;me,&nbsp;&nbsp;string&nbsp;text)&nbsp;<BR>
{&nbsp;<BR>
&nbsp;<BR>
write_file(BBSLEAVE_TOWIZ_DIR+(string)(spe_filenum),&nbsp;text);&nbsp;<BR>
&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;QUIT_D-&gt;leave_world(me);&nbsp;<BR>
&nbsp;return;&nbsp;<BR>
}&nbsp;<BR>
&nbsp;<BR>
private&nbsp;void&nbsp;confirm_main_choice(string&nbsp;yn,&nbsp;object&nbsp;ob)&nbsp;<BR>
{&nbsp;<BR>
int&nbsp;i;&nbsp;<BR>
string&nbsp;*file_header;&nbsp;<BR>
&nbsp;<BR>
&nbsp;file_header=({&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;,&quot;10&quot;,});&nbsp;<BR>
&nbsp;<BR>
&nbsp;if(&nbsp;yn==&quot;&quot;&nbsp;)&nbsp;{&nbsp;<BR>
&nbsp;&nbsp;&nbsp;write(YEL&quot;\r请输入您的选择:&quot;NOR);&nbsp;<BR>
&nbsp;&nbsp;&nbsp;input_to(&nbsp;(:&nbsp;confirm_main_choice&nbsp;:),&nbsp;ob&nbsp;);&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<BR>
&nbsp;<BR>
&nbsp;switch(yn[0]){&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;'E':&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;'e':&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;'4':&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;&nbsp;<BR>
&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;'1':&nbsp;//write&nbsp;the&nbsp;word&nbsp;to&nbsp;player&nbsp;now.&nbsp;<BR>
&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spe_filenum=BBSFILE_D-&gt;total_file_num(BBSLEAVE_DIR);&nbsp;<BR>
&nbsp;<BR>
//&nbsp;write(&quot;total&nbsp;file&nbsp;here&nbsp;is&nbsp;:&nbsp;&quot;+(string)spe_filenum+&quot;\n&quot;);&nbsp;<BR>
&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file_header=init_fileheader();&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BBSFILE_D-&gt;set_file_header(BBSLEAVE_DIR+(string)spe_filenum,file_header);&nbsp;<BR>
&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this_player()-&gt;edit(&nbsp;(:&nbsp;done_write,&nbsp;this_player()&nbsp;:)&nbsp;);&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;'2':&nbsp;&nbsp;<BR>
//just&nbsp;leave&nbsp;without&nbsp;msg&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;QUIT_D-&gt;leave_world(this_player());&nbsp;<BR>
&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;'3':&nbsp;&nbsp;<BR>
//to&nbsp;wizard&nbsp;here&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;spe_filenum=BBSFILE_D-&gt;total_file_num(BBSLEAVE_TOWIZ_DIR);&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file_header=init_fileheader();&nbsp;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;BBSFILE_D-&gt;set_file_header(BBSLEAVE_TOWIZ_DIR+(string)spe_filenum,file_header);&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this_player()-&gt;edit(&nbsp;(:&nbsp;done_write_towiz,&nbsp;this_player()&nbsp;:)&nbsp;);&nbsp;<BR>
&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;&nbsp;<BR>
&nbsp;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;default:&nbsp;<BR>
&nbsp;&nbsp;&nbsp;write(YEL&quot;\r请输入您的选择:&quot;NOR);&nbsp;<BR>
&nbsp;&nbsp;&nbsp;input_to(&nbsp;(:&nbsp;confirm_main_choice&nbsp;:),&nbsp;ob&nbsp;);&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<BR>
return;&nbsp;<BR>
}&nbsp;<BR>
string*&nbsp;init_fileheader()&nbsp;<BR>
{&nbsp;<BR>
string*&nbsp;file_header;&nbsp;<BR>
int&nbsp;i;&nbsp;<BR>
&nbsp;<BR>
file_header=({&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;4&quot;,&quot;5&quot;,&quot;6&quot;,&quot;7&quot;,&quot;8&quot;,&quot;9&quot;,&quot;10&quot;,});&nbsp;<BR>
&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file_header[0]=this_player()-&gt;query(&quot;id&quot;);&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file_header[1]=this_player()-&gt;query(&quot;name&quot;);&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file_header[2]=this_player()-&gt;query(&quot;title&quot;);&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file_header[3]=this_player()-&gt;query(&quot;gender&quot;);&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file_header[4]=this_player()-&gt;query(&quot;age&quot;);&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file_header[5]=this_player()-&gt;query(&quot;combat_exp&quot;);&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file_header[6]=query_ip_name(this_player());&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file_header[7]=(string)time();&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for(i=8;i&lt;10;i++)&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file_header[i]=&quot;nothing&quot;;&nbsp;<BR>
return&nbsp;file_header;&nbsp;<BR>
}&nbsp;<BR>
&nbsp;<BR>
2)&nbsp;<BR>
/adm/daemons/bbsfiled.c提供的函数&nbsp;<BR>
int&nbsp;set_file_header(string&nbsp;file,string*&nbsp;tobeset)&nbsp;<BR>
{&nbsp;<BR>
&nbsp;string&nbsp;list2;&nbsp;<BR>
&nbsp;int&nbsp;i;&nbsp;<BR>
&nbsp;<BR>
//&nbsp;&nbsp;&nbsp;&nbsp;list&nbsp;=&nbsp;explode(read_file(file),&nbsp;&quot;\n&quot;);&nbsp;<BR>
//need&nbsp;not&nbsp;read&nbsp;the&nbsp;file&nbsp;just&nbsp;rm&nbsp;them&nbsp;<BR>
&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;for(list2&nbsp;=&nbsp;&quot;&quot;,&nbsp;i=0;&nbsp;i&nbsp;&lt;&nbsp;10;&nbsp;i++){&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;list2+=&nbsp;tobeset[i]+&quot;\n&quot;;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<BR>
&nbsp;&nbsp;rm(file);&nbsp;<BR>
&nbsp;&nbsp;write_file(file,&nbsp;list2);&nbsp;<BR>
&nbsp;<BR>
&nbsp;&nbsp;return&nbsp;1;&nbsp;<BR>
}&nbsp;<BR>
&nbsp;<BR>
int&nbsp;total_file_num(string&nbsp;directory)&nbsp;<BR>
{&nbsp;<BR>
int&nbsp;number;&nbsp;<BR>
string&nbsp;*dir;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dir&nbsp;=&nbsp;get_dir(directory+&quot;/&quot;);&nbsp;<BR>
//the&nbsp;&quot;/&quot;&nbsp;must&nbsp;be&nbsp;added&nbsp;!!!&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;number=sizeof(dir);&nbsp;<BR>
return&nbsp;number;&nbsp;<BR>
}&nbsp;<BR>
&nbsp;<BR>
3)&nbsp;<BR>
/include/globals.h中的定义&nbsp;<BR>
&nbsp;<BR>
#define&nbsp;BBSLEAVE_DIR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;/data/bbs/leavemsg_player/&quot;&nbsp;<BR>
#define&nbsp;BBSLEAVE_TOWIZ_DIR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;/data/bbs/leavemsg_towiz/&quot;&nbsp;<BR>
&nbsp;<BR>
4)&nbsp;<BR>
/clone/user/user.c(XKX)或者/std/user/user.c(ES2)的改动&nbsp;<BR>
&nbsp;<BR>
将所有的command(&quot;quit&quot;)&nbsp;<BR>
换成&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;QUIT_D-&gt;leave_world(this_object());&nbsp;<BR>
&nbsp;<BR>
5)&nbsp;<BR>
/feature/alias.c的改动&nbsp;<BR>
将所有的command(&quot;quit&quot;)&nbsp;<BR>
换成&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;QUIT_D-&gt;leave_world(this_object());&nbsp;<BR>
&nbsp;<BR>
6)&nbsp;<BR>
增加一个新的文件/adm/daemons/quitd.c&nbsp;<BR>
在/include/globals.h中的相关定义为QUIT_D&nbsp;&nbsp;&quot;/adm/daemons/quitd.c&quot;&nbsp;<BR>
&nbsp;其中包含所有以前的quit.c中用户退出世界的操作。&nbsp;<BR>
&nbsp;以后要修改的话，应该在这里修改。&nbsp;<BR>
&nbsp;<BR>
例如：&nbsp;<BR>
#include&nbsp;&lt;ansi.h&gt;&nbsp;<BR>
#include&nbsp;&lt;command.h&gt;&nbsp;<BR>
&nbsp;<BR>
void&nbsp;create()&nbsp;{&nbsp;seteuid(getuid());&nbsp;}&nbsp;<BR>
&nbsp;<BR>
int&nbsp;leave_world(object&nbsp;me)&nbsp;<BR>
{&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;object&nbsp;*inv,&nbsp;link_ob;&nbsp;<BR>
int&nbsp;i;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(&nbsp;!wizardp(me)&nbsp;)&nbsp;{&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inv&nbsp;=&nbsp;all_inventory(me);&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for(i=0;&nbsp;i&lt;sizeof(inv);&nbsp;i++)&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(&nbsp;!inv[i]-&gt;query_autoload()&nbsp;)&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DROP_CMD-&gt;do_drop(me,&nbsp;inv[i]);&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<BR>
&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;link_ob&nbsp;=&nbsp;me-&gt;query_temp(&quot;link_ob&quot;);&nbsp;<BR>
&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;We&nbsp;might&nbsp;be&nbsp;called&nbsp;on&nbsp;a&nbsp;link_dead&nbsp;player,&nbsp;so&nbsp;check&nbsp;this.&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(&nbsp;link_ob&nbsp;)&nbsp;{&nbsp;<BR>
&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Are&nbsp;we&nbsp;possessing&nbsp;in&nbsp;others&nbsp;body&nbsp;?&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(&nbsp;link_ob-&gt;is_character()&nbsp;)&nbsp;{&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;write(&quot;你的魂魄回到&quot;&nbsp;+&nbsp;link_ob-&gt;name(1)&nbsp;+&nbsp;&quot;的身上。\n&quot;);&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exec(link_ob,&nbsp;me);&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;link_ob-&gt;setup();&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<BR>
&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;link_ob-&gt;set(&quot;last_on&quot;,&nbsp;time());&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;link_ob-&gt;set(&quot;last_from&quot;,&nbsp;query_ip_name(me));&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;link_ob-&gt;save();&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;destruct(link_ob);&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(wizardp(me))&nbsp;me-&gt;set(&quot;startroom&quot;,&quot;/newd/wizard/wizard_room&quot;);&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;write(&quot;欢迎下次再来！\n&quot;);&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;message(&quot;system&quot;,&nbsp;me-&gt;name()&nbsp;+&nbsp;&quot;离开游戏。\n&quot;,&nbsp;environment(me),&nbsp;me);&nbsp;<BR>
&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CHANNEL_D-&gt;do_channel(this_object(),&nbsp;&quot;sys&quot;,&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;me-&gt;name()&nbsp;+&nbsp;&quot;离开游戏了。&quot;);&nbsp;<BR>
&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;me-&gt;save();&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;destruct(me);&nbsp;<BR>
&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1;&nbsp;<BR>
}&nbsp;<BR>
&nbsp;<BR>
7)&nbsp;<BR>
/adm/daemons/logind.c的改动，以便玩家，巫师能够看到用户留言&nbsp;<BR>
&nbsp;<BR>
string&nbsp;leave_msg_player(int&nbsp;file_index);&nbsp;<BR>
string&nbsp;leave_msg_towiz(int&nbsp;file_index);&nbsp;<BR>
string&nbsp;leave_title_player(int&nbsp;file_index);&nbsp;<BR>
string&nbsp;leave_title_wizard(int&nbsp;file_index);&nbsp;<BR>
&nbsp;<BR>
//this&nbsp;function&nbsp;can&nbsp;be&nbsp;set&nbsp;to&nbsp;the&nbsp;logind&nbsp;file&nbsp;<BR>
//so&nbsp;player&nbsp;can&nbsp;get&nbsp;the&nbsp;msg..................&nbsp;<BR>
&nbsp;<BR>
&nbsp;在所有的&nbsp;<BR>
enter_world(&nbsp;&nbsp;);&nbsp;<BR>
函数后面加入&nbsp;<BR>
msg_player()&nbsp;<BR>
即可。&nbsp;<BR>
&nbsp;<BR>
void&nbsp;msg_player()&nbsp;<BR>
{&nbsp;<BR>
int&nbsp;last_leave_read,i;&nbsp;<BR>
string&nbsp;leave_msg;&nbsp;<BR>
&nbsp;<BR>
&nbsp;<BR>
last_leave_read=(int)this_player()-&gt;query(&quot;last_leave_read/player&quot;);&nbsp;<BR>
&nbsp;<BR>
spe_filenum=0;&nbsp;<BR>
leave_msg=&quot;&quot;;&nbsp;<BR>
&nbsp;<BR>
spe_filenum=BBSFILE_D-&gt;total_file_num(BBSLEAVE_DIR);&nbsp;<BR>
&nbsp;<BR>
//no&nbsp;messge&nbsp;or&nbsp;message&nbsp;have&nbsp;been&nbsp;changed&nbsp;<BR>
if((spe_filenum==0&nbsp;||&nbsp;last_leave_read&nbsp;&gt;&nbsp;spe_filenum)&nbsp;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;!wizardp(this_player())){&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this_player()-&gt;delete(&quot;last_leave_read/player&quot;);&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<BR>
&nbsp;<BR>
&nbsp;<BR>
for(i=last_leave_read;i&lt;spe_filenum;i++)&nbsp;{&nbsp;<BR>
&nbsp;&nbsp;if(sizeof(leave_msg_player(i))&nbsp;!=0)&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;leave_msg+=leave_title_player(i)+leave_msg_player(i)+&quot;\n&quot;;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<BR>
&nbsp;<BR>
this_player()-&gt;set(&quot;last_leave_read/player&quot;,spe_filenum);&nbsp;<BR>
&nbsp;<BR>
&nbsp;<BR>
if(wizardp(this_player()))&nbsp;{&nbsp;<BR>
&nbsp;<BR>
&nbsp;<BR>
last_leave_read=(int)this_player()-&gt;query(&quot;last_leave_read/wizard&quot;);&nbsp;<BR>
&nbsp;<BR>
spe_filenum=0;&nbsp;<BR>
&nbsp;<BR>
spe_filenum=BBSFILE_D-&gt;total_file_num(BBSLEAVE_TOWIZ_DIR);&nbsp;<BR>
&nbsp;<BR>
//&nbsp;write(&quot;num&nbsp;is:&quot;+(string)spe_filenum);&nbsp;<BR>
&nbsp;<BR>
//no&nbsp;messge&nbsp;or&nbsp;message&nbsp;have&nbsp;been&nbsp;changed&nbsp;<BR>
&nbsp;<BR>
if(spe_filenum==0&nbsp;||&nbsp;last_leave_read&nbsp;&gt;&nbsp;spe_filenum)&nbsp;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this_player()-&gt;delete(&quot;last_leave_read/wizard&quot;);&nbsp;<BR>
//for&nbsp;no&nbsp;one&nbsp;delete&nbsp;it&nbsp;so&nbsp;the&nbsp;num&nbsp;is&nbsp;连续的，so&nbsp;need&nbsp;not&nbsp;<BR>
//考虑顺序问题。&nbsp;<BR>
for(i=last_leave_read;i&lt;spe_filenum;i++)&nbsp;&nbsp;{&nbsp;<BR>
&nbsp;&nbsp;if(sizeof(leave_msg_towiz(i))&nbsp;!=0)&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;leave_msg+=leave_title_wizard(i)+leave_msg_towiz(i)+&quot;\n&quot;;&nbsp;<BR>
&nbsp;<BR>
//leave_msg+=&nbsp;<BR>
//&quot;□―――――――――――――――――――――――――――――――――――□\n&quot;;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<BR>
&nbsp;<BR>
this_player()-&gt;set(&quot;last_leave_read/wizard&quot;,spe_filenum);&nbsp;<BR>
&nbsp;<BR>
&nbsp;&nbsp;&nbsp;}&nbsp;<BR>
&nbsp;<BR>
leave_more(&quot;&quot;,&nbsp;explode(leave_msg,&nbsp;&quot;\n&quot;),&nbsp;0);&nbsp;<BR>
&nbsp;<BR>
return;&nbsp;<BR>
&nbsp;<BR>
}&nbsp;<BR>
//player's&nbsp;title&nbsp;who&nbsp;write&nbsp;the&nbsp;msg&nbsp;<BR>
string&nbsp;leave_title_player(int&nbsp;file_index)&nbsp;<BR>
{&nbsp;<BR>
string*&nbsp;header;&nbsp;<BR>
string&nbsp;title;&nbsp;<BR>
title=&quot;&quot;;&nbsp;<BR>
&nbsp;<BR>
&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;header=BBSFILE_D-&gt;get_all_fileheader(BBSLEAVE_DIR+(string)file_index);&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if((int)header==0)&nbsp;return&nbsp;0;&nbsp;<BR>
&nbsp;<BR>
//&nbsp;title=HBYEL&quot;______________________________________________________\n&quot;;&nbsp;<BR>
title=HBYEL+sprintf(HIB&quot;%-20s&quot;&nbsp;&nbsp;&nbsp;HBBLU&nbsp;&nbsp;HIR&quot;%s(%s)&quot;HBGRN&nbsp;HIW&quot;&nbsp;在&nbsp;%20s&nbsp;临走之前说道:&quot;+&quot;\n&quot;,&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;header[2],&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;header[1],&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;header[0],&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ctime(to_int(header[7])));&nbsp;<BR>
&nbsp;<BR>
return&nbsp;title;&nbsp;<BR>
}&nbsp;<BR>
&nbsp;<BR>
//get&nbsp;the&nbsp;title&nbsp;msg&nbsp;of&nbsp;writing&nbsp;to&nbsp;wizqrd&nbsp;<BR>
string&nbsp;leave_title_wizard(int&nbsp;file_index)&nbsp;<BR>
{&nbsp;<BR>
string*&nbsp;header;&nbsp;<BR>
string&nbsp;title;&nbsp;<BR>
title=&quot;&quot;;&nbsp;<BR>
&nbsp;<BR>
&nbsp;<BR>
&nbsp;header=BBSFILE_D-&gt;get_all_fileheader(BBSLEAVE_TOWIZ_DIR+(string)file_index);&nbsp;<BR>
&nbsp;if((int)header==0)&nbsp;return&nbsp;0;&nbsp;<BR>
&nbsp;<BR>
//here&nbsp;borrow&nbsp;from&nbsp;tsinghua,hehe&nbsp;<BR>
title+=&nbsp;<BR>
&quot;□┬―――――――――――――――――――――――――――――――――┬□\n&quot;;&nbsp;<BR>
title+=HBYEL&nbsp;<BR>
+sprintf(HIR+&nbsp;<BR>
&quot;□┤%-20s&quot;&nbsp;&nbsp;+&nbsp;HBBLU+HBGRN+HIW&quot;&nbsp;&nbsp;&nbsp;&nbsp;在&nbsp;%-20s&nbsp;离开时留下的话&quot;+&quot;├□\n&quot;,&nbsp;<BR>
&nbsp;header[0]+&quot;（&quot;&nbsp;+header[1]+&quot;）&quot;,&nbsp;<BR>
&nbsp;ctime(to_int(header[7])));&nbsp;<BR>
return&nbsp;title;&nbsp;<BR>
}&nbsp;<BR>
string&nbsp;leave_msg_towiz(int&nbsp;file_index)&nbsp;<BR>
{&nbsp;<BR>
int&nbsp;i;&nbsp;<BR>
string&nbsp;list;&nbsp;<BR>
string*&nbsp;list2;&nbsp;<BR>
string&nbsp;msg;&nbsp;<BR>
&nbsp;<BR>
//here&nbsp;maybe&nbsp;important&nbsp;<BR>
&nbsp;<BR>
&nbsp;msg=&quot;&quot;;&nbsp;<BR>
&nbsp;<BR>
&nbsp;&nbsp;&nbsp;list=read_file(BBSLEAVE_TOWIZ_DIR+(string)file_index);&nbsp;<BR>
&nbsp;<BR>
if(!list)&nbsp;return&nbsp;0;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;list2&nbsp;=&nbsp;explode(list,&nbsp;&quot;\n&quot;);&nbsp;<BR>
&nbsp;<BR>
//lenth&nbsp;too&nbsp;short&nbsp;so&nbsp;don't&nbsp;display&nbsp;it&nbsp;<BR>
if(sizeof(list2)&nbsp;&lt;=&nbsp;&nbsp;10&nbsp;)&nbsp;return&nbsp;0;&nbsp;<BR>
else&nbsp;if(&nbsp;list[10]&nbsp;&lt;&nbsp;2&nbsp;)&nbsp;return&nbsp;0;&nbsp;<BR>
&nbsp;<BR>
for(i=10;i&lt;sizeof(list2);i++)&nbsp;{&nbsp;<BR>
msg+=HBYEL&nbsp;<BR>
+sprintf(HIR+&nbsp;<BR>
&nbsp;&nbsp;&quot;│&quot;HIW&quot;%-70s&quot;+&quot;│\n&quot;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,&nbsp;list2[i]);&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<BR>
//msg+=HBYEL&nbsp;<BR>
//&quot;□┬―――――――――――――――――――――――――――――――――┬□\n&quot;;&nbsp;<BR>
&nbsp;<BR>
return&nbsp;msg;&nbsp;<BR>
&nbsp;<BR>
}&nbsp;<BR>
//get&nbsp;the&nbsp;msg&nbsp;of&nbsp;the&nbsp;player&nbsp;<BR>
string&nbsp;leave_msg_player(int&nbsp;file_index)&nbsp;<BR>
{&nbsp;<BR>
int&nbsp;i;&nbsp;<BR>
string&nbsp;list;&nbsp;<BR>
string*&nbsp;list2;&nbsp;<BR>
string&nbsp;msg;&nbsp;<BR>
&nbsp;msg=&quot;&quot;;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;list=read_file(BBSLEAVE_DIR+(string)file_index);&nbsp;<BR>
&nbsp;<BR>
if(!list)&nbsp;return&nbsp;0;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;list2&nbsp;=&nbsp;explode(list,&nbsp;&quot;\n&quot;);&nbsp;<BR>
&nbsp;<BR>
&nbsp;&nbsp;//lenth&nbsp;too&nbsp;short&nbsp;so&nbsp;don't&nbsp;display&nbsp;it&nbsp;<BR>
if(sizeof(list2)&nbsp;&lt;=&nbsp;&nbsp;10&nbsp;)&nbsp;return&nbsp;0;&nbsp;<BR>
else&nbsp;if(&nbsp;list[10]&nbsp;&lt;&nbsp;2&nbsp;)&nbsp;return&nbsp;0;&nbsp;<BR>
&nbsp;<BR>
for(i=10;i&lt;sizeof(list2);i++)&nbsp;{&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;msg+=list2[i]+&quot;\n&quot;;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<BR>
return&nbsp;msg;&nbsp;<BR>
&nbsp;<BR>
}&nbsp;<BR>
//change&nbsp;the&nbsp;more&nbsp;file&nbsp;so&nbsp;can&nbsp;be&nbsp;fit&nbsp;to&nbsp;this&nbsp;&nbsp;<BR>
//use&nbsp;<BR>
void&nbsp;leave_more(string&nbsp;cmd,&nbsp;string&nbsp;*text,&nbsp;int&nbsp;line)&nbsp;<BR>
{&nbsp;<BR>
&nbsp;int&nbsp;i,j;&nbsp;<BR>
&nbsp;<BR>
&nbsp;switch(cmd)&nbsp;{&nbsp;<BR>
&nbsp;case&nbsp;&quot;&quot;:&nbsp;<BR>
&nbsp;for(i=line&nbsp;+&nbsp;23;&nbsp;line&lt;sizeof(text)&nbsp;&amp;&amp;&nbsp;line&lt;i;&nbsp;line++)&nbsp;<BR>
&nbsp;write(text[line]&nbsp;+&nbsp;&quot;\n&quot;);&nbsp;<BR>
&nbsp;if(&nbsp;line&gt;=sizeof(text)&nbsp;)&nbsp;{&nbsp;<BR>
&nbsp;write(MAG&quot;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;请输入回车键后结束:&quot;);&nbsp;<BR>
&nbsp;input_to(&nbsp;(:&nbsp;confirm_enter_key&nbsp;:),&nbsp;this_player()&nbsp;);&nbsp;<BR>
&nbsp;&nbsp;return;&nbsp;<BR>
&nbsp;}&nbsp;<BR>
&nbsp;break;&nbsp;<BR>
&nbsp;case&nbsp;&quot;b&quot;:&nbsp;<BR>
&nbsp;line&nbsp;=&nbsp;line&nbsp;-&nbsp;46;&nbsp;<BR>
&nbsp;&nbsp;if(line&lt;-22)&nbsp;{&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_display();&nbsp;<BR>
&nbsp;write(MAG&quot;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;请输入回车键后结束:&quot;);&nbsp;<BR>
&nbsp;input_to(&nbsp;(:&nbsp;confirm_enter_key&nbsp;:),&nbsp;this_player()&nbsp;);&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<BR>
&nbsp;for(i=line&nbsp;+&nbsp;23;&nbsp;line&nbsp;&lt;&nbsp;i;line++)&nbsp;<BR>
&nbsp;write(text[line]+&quot;\n&quot;);&nbsp;<BR>
&nbsp;<BR>
break;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;case&nbsp;&quot;q&quot;:&nbsp;<BR>
&nbsp;write(MAG&quot;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;请输入回车键后结束:&quot;);&nbsp;<BR>
&nbsp;input_to(&nbsp;(:&nbsp;confirm_enter_key&nbsp;:),&nbsp;this_player()&nbsp;);&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;&nbsp;<BR>
&nbsp;<BR>
&nbsp;}&nbsp;<BR>
//guess&nbsp;it&nbsp;is&nbsp;useless&nbsp;and&nbsp;awful,so&nbsp;removed&nbsp;it&nbsp;<BR>
//printf(&quot;==&nbsp;未完继续&nbsp;&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;%d%%&quot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&nbsp;==&nbsp;(ENTER&nbsp;继续下一页，q&nbsp;离开，b&nbsp;前一页)&quot;,&nbsp;<BR>
//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(line*100/sizeof(text))&nbsp;);&nbsp;<BR>
&nbsp;&nbsp;input_to(&quot;leave_more&quot;,&nbsp;text,&nbsp;line);&nbsp;<BR>
return;&nbsp;<BR>
}&nbsp;<BR>
其中用户连线进入世界时所看到的消息的构架，还看起来不完善，&nbsp;<BR>
可以仿照bbs的进站画面去完善。加入那些框架。&nbsp;<BR>
如果忘了什么函数，无法正常工作，请通知我。&nbsp;<BR>
如果有什么bug，可在此指出。&nbsp;<BR>
&nbsp;<BR>
实际上程序的核心是留言文件的组织，其它都不难。&nbsp;<BR>
&nbsp;<BR>
&nbsp;<BR>
烛光泪影&nbsp;<BR>
sad&nbsp;song&nbsp;<BR>
&nbsp;<BR>
--&nbsp;<BR>
※&nbsp;来源:・BBS&nbsp;水木清华站&nbsp;bbs.net.tsinghua.edu.cn・[FROM:&nbsp;ftp.nju.edu.cn]&nbsp;<BR>
<A HREF="00000008.htm">上一篇</A>
<A HREF='javascript:history.go(-1)'>返回上一页</A>
<A HREF="index.htm">回到目录</A>
<A HREF="#top">回到页首</A>
<A HREF="00000010.htm">下一篇</A>
</H1></CENTER>
<CENTER><H1>BBS水木清华站∶精华区</H1></CENTER>
</BODY></HTML>