<HTML>
<HEAD>
<TITLE>BBS水木清華站︰精華區</TITLE>
</HEAD>
<BODY>
<CENTER><H1>BBS水木清華站︰精華區</H1></CENTER>
<A Name="top"></a>
發信人:&nbsp;yeung&nbsp;(流星雨),&nbsp;信區:&nbsp;Mud_Builder&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>
標&nbsp;&nbsp;題:&nbsp;MUDOS中的函數指針&nbsp;-&nbsp;II&nbsp;<BR>
發信站:&nbsp;BBS&nbsp;水木清華站&nbsp;(Thu&nbsp;Dec&nbsp;23&nbsp;00:10:09&nbsp;1999)&nbsp;<BR>
&nbsp;<BR>
&nbsp;<BR>
嗯,安靜安靜,開講!&nbsp;<BR>
&nbsp;<BR>
剛剛我們講的函數指針都是一個單純的函數,什麼參數都沒帶,實際上,&nbsp;<BR>
是可以帶參數的,比如&nbsp;<BR>
int&nbsp;my_function(string&nbsp;s1,string&nbsp;s2)&nbsp;<BR>
{&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;write(s1&nbsp;+&nbsp;&quot;和&quot;&nbsp;+&nbsp;s2&nbsp;+&nbsp;&quot;都是不折不扣的豬!\n&quot;);&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1;&nbsp;<BR>
}&nbsp;<BR>
&nbsp;<BR>
現在我們再來製造一個函數指針.&nbsp;<BR>
function&nbsp;f&nbsp;=&nbsp;(:&nbsp;my_function,&quot;nerd&quot;&nbsp;:);&nbsp;<BR>
這樣,相當於第一參數已經定死是&quot;nerd&quot;了,可以這麼調用:&nbsp;<BR>
evaluate(f,&quot;akuma&quot;);&nbsp;<BR>
結果當然是&nbsp;&quot;nerd和akuma都是不折不扣的豬!\n&quot;&nbsp;<BR>
evaluate(f);&nbsp;<BR>
結果是&quot;nerd和0都是不折不扣的豬!\n&quot;&nbsp;&nbsp;<BR>
呵呵.&nbsp;<BR>
&nbsp;<BR>
函數指針除了可以是自己的函數之外,還可以是EFUN&nbsp;<BR>
比如object()這個EFUN支持一個東東(過濾函數)當作參數.&nbsp;<BR>
object(&nbsp;(:clonep:)&nbsp;)&nbsp;<BR>
就是返回這個MUD裡面所有是clone的物件.&nbsp;<BR>
當然,EFUN的函數指針也一樣是可以帶參數的.&nbsp;<BR>
void&nbsp;create()&nbsp;<BR>
{&nbsp;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;i;&nbsp;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;f&nbsp;=&nbsp;(:&nbsp;write,&nbsp;&quot;Hello,&nbsp;world!\n&quot;&nbsp;:);&nbsp;&nbsp;<BR>
&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(i=0;&nbsp;i&lt;3;&nbsp;i++)&nbsp;{&nbsp;evaluate(f);&nbsp;}&nbsp;&nbsp;<BR>
}&nbsp;&nbsp;<BR>
&nbsp;<BR>
結果是&nbsp;Hello,&nbsp;world!&nbsp;Hello,&nbsp;world!&nbsp;Hello,&nbsp;world!&nbsp;&nbsp;<BR>
&nbsp;<BR>
上面我們只顧說EFUN了,實際上,SIMUL_EFUN可以完全當成EFUN來看待,沒有&nbsp;<BR>
任何區別.&nbsp;<BR>
&nbsp;<BR>
剛剛我們討論的全都是自己的函數或者系統的EFUN,別人的偷來用可不可以呢?&nbsp;<BR>
當然可以.&nbsp;<BR>
這時候的函數指針這麼生成:&nbsp;<BR>
function&nbsp;f;&nbsp;<BR>
f&nbsp;=&nbsp;(:&nbsp;call_other,akuma,&quot;become_pig&quot;&nbsp;:);&nbsp;<BR>
這時候,evaluate(f)就相當於&nbsp;akuma-&gt;become_pig();&nbsp;<BR>
當然參數也可以在後面帶上.&nbsp;<BR>
&nbsp;<BR>
第四種情形(到底第幾種?我自己都迷糊了)是,直接用(:&nbsp;:)表達式弄出來的函數&nbsp;<BR>
指針.這種情形下,$1,$2,$3.....被當作是第一,第二,第三....個參數.&nbsp;<BR>
比如&nbsp;evaluate(&nbsp;(:&nbsp;$1&nbsp;+&nbsp;$2&nbsp;:),&nbsp;3,&nbsp;4);&nbsp;&nbsp;會返回7&nbsp;<BR>
又比如&nbsp;/feature/attack.c&nbsp;的一段&nbsp;<BR>
if(&nbsp;arrayp(guards&nbsp;=&nbsp;ob-&gt;query_temp(&quot;guarded&quot;))&nbsp;)&nbsp;{&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;guards&nbsp;=&nbsp;filter_array(guards,&nbsp;(:&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;objectp($1)&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;living($1)&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$1&nbsp;!=&nbsp;this_object()&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;present($1,&nbsp;environment())&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!is_fighting($1)&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$1-&gt;visible(this_object())&nbsp;:));&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(&nbsp;sizeof(guards)&nbsp;&gt;&nbsp;0&nbsp;)&nbsp;{&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;guards&nbsp;must&nbsp;be&nbsp;added&nbsp;to&nbsp;enemy&nbsp;prior&nbsp;to&nbsp;call&nbsp;guards&nbsp;join&nbsp;the&nbsp;fight&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;thus&nbsp;can&nbsp;prevent&nbsp;infinite&nbsp;loop&nbsp;in&nbsp;the&nbsp;mutual&nbsp;guard&nbsp;case.&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;enemy&nbsp;+=&nbsp;guards;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;message(&quot;vision&quot;,&nbsp;HIR&nbsp;+&nbsp;ob-&gt;name()&nbsp;+&nbsp;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;受到攻擊！你挺身加入戰團！\n&quot;&nbsp;NOR,&nbsp;guards);&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;guards-&gt;kill_ob(this_object());&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<BR>
}&nbsp;<BR>
應用最多的情形就是filter_array和sort_array,尤其是後者.&nbsp;<BR>
&nbsp;<BR>
比如十大豬頭排名:&nbsp;<BR>
object&nbsp;*top_ten&nbsp;=&nbsp;sort_array(&nbsp;users(),&nbsp;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(:&nbsp;$2-&gt;query_pig_level()&nbsp;-&nbsp;$1-&gt;query_pig_level()&nbsp;:)&nbsp;)[0..9];&nbsp;&nbsp;<BR>
&nbsp;<BR>
怎麼樣,很簡潔吧.&nbsp;:)&nbsp;<BR>
&nbsp;<BR>
第5種類型,是所謂的&quot;匿名&quot;函數&quot;指針,意思是指向的函數根本沒有一個名字的.&nbsp;<BR>
比如&nbsp;<BR>
function&nbsp;f&nbsp;=&nbsp;function(int&nbsp;x)&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;y;&nbsp;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch(x)&nbsp;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;1:&nbsp;y&nbsp;=&nbsp;3;&nbsp;case&nbsp;2:&nbsp;y&nbsp;=&nbsp;5;&nbsp;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;y&nbsp;-&nbsp;2;&nbsp;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};&nbsp;&nbsp;<BR>
執行&nbsp;<BR>
printf(&quot;%i&nbsp;%i&nbsp;%i\n&quot;,&nbsp;(*f)(1),&nbsp;(*f)(2),&nbsp;(*f)(3));&nbsp;}&nbsp;&nbsp;<BR>
的結果是&nbsp;1&nbsp;3&nbsp;-2&nbsp;&nbsp;<BR>
&nbsp;<BR>
除了evaluate之外,直接引用指針的內容也是一樣的,比如&nbsp;evaluate(f,&quot;akuma&quot;)和&nbsp;<BR>
(*f)(&quot;akuma&quot;)是一回事,只是evaluate舒服一些.&nbsp;<BR>
&nbsp;<BR>
留一道題,把下面的程序用一行弄出來.&nbsp;<BR>
&nbsp;<BR>
比如我們的拆大腦巫師石頭(shi)的傑作:&nbsp;<BR>
&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;object&nbsp;*member=users();&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(&nbsp;i=0;i&lt;sizeof(member);i++)&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>
if(member[i]-&gt;query(&quot;family/family_name&quot;)==query(&quot;family/family_name&quot;)&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;member[i]-&gt;query(&quot;combat_exp&quot;)&nbsp;&gt;=&nbsp;exp*8/10&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;!(!undefinedp(list[id])&nbsp;&amp;&amp;&nbsp;&nbsp;<BR>
member_array(member[i]-&gt;query(&quot;id&quot;),&nbsp;list[id])!=-1)&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;!member[i]-&gt;is_ghost()&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;!member[i]-&gt;query_temp(&quot;block_msg/all&quot;)&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;!wizardp(member[i])&nbsp;)&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;member[i]&nbsp;=&nbsp;0;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;member&nbsp;-=({0});&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>
&nbsp;<BR>
還有點細節問題,第三講啦&nbsp;<BR>
&nbsp;<BR>
&nbsp;<BR>
&nbsp;<BR>
&nbsp;<BR>
--&nbsp;<BR>
夢後樓台高鎖，酒醒簾幕低垂&nbsp;<BR>
去年春恨卻來時，落花人獨立，微雨燕雙飛&nbsp;<BR>
&nbsp;<BR>
記得小蘋初見，兩重心字羅衣&nbsp;<BR>
琵琶弦上說相思，當時明月在，曾照彩雲歸&nbsp;<BR>
&nbsp;<BR>
※&nbsp;修改:•yeung&nbsp;於&nbsp;Dec&nbsp;23&nbsp;00:38:36&nbsp;修改本文•[FROM:&nbsp;&nbsp;162.105.138.50]&nbsp;<BR>
※&nbsp;來源:•BBS&nbsp;水木清華站&nbsp;smth.org•[FROM:&nbsp;162.105.138.50]&nbsp;<BR>
<A HREF="00000000.htm">上一篇</A>
<A HREF='javascript:history.go(-1)'>返回上一頁</A>
<A HREF="index.htm">回到目錄</A>
<A HREF="#top">回到頁首</A>
<A HREF="00000002.htm">下一篇</A>
</H1></CENTER>
<CENTER><H1>BBS水木清華站︰精華區</H1></CENTER>
</BODY></HTML>