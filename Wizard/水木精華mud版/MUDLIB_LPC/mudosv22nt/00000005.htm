<HTML>
<HEAD>
<TITLE>BBS水木清華站︰精華區</TITLE>
</HEAD>
<BODY>
<CENTER><H1>BBS水木清華站︰精華區</H1></CENTER>
<A Name="top"></a>
發信人:&nbsp;wwj&nbsp;(星~~畢設中),&nbsp;信區:&nbsp;Mud_Builder&nbsp;<BR>
標&nbsp;&nbsp;題:&nbsp;附錄一&nbsp;&nbsp;&nbsp;&nbsp;V21版的mudlib轉V22版時應注意的問題&nbsp;<BR>
發信站:&nbsp;BBS&nbsp;水木清華站&nbsp;(Sat&nbsp;May&nbsp;16&nbsp;19:08:09&nbsp;1998)&nbsp;<BR>
&nbsp;<BR>
&nbsp;&nbsp;&nbsp;如果你原來用的是MudOS&nbsp;v21.xx,&nbsp;則升級至v22需要進行以下改動：&nbsp;<BR>
&nbsp;<BR>
1、刪除所有文件中在子類或外部使用的函數前面的private關鍵字。&nbsp;<BR>
&nbsp;&nbsp;&nbsp;或者簡單地刪除所有函數前面的private就行了。&nbsp;<BR>
比如：/feature/attack.c中的：&nbsp;<BR>
private&nbsp;int&nbsp;attack()&nbsp;<BR>
....&nbsp;<BR>
改為&nbsp;int&nbsp;attack()&nbsp;<BR>
&nbsp;<BR>
類似的情況還有：&nbsp;<BR>
&nbsp;&nbsp;/feature/action.c,&nbsp;treemap.c&nbsp;等。&nbsp;<BR>
&nbsp;<BR>
2、注意函數聲明的類型要與函數實際類型相同&nbsp;<BR>
比如：&nbsp;<BR>
void&nbsp;myfunction();&nbsp;<BR>
....&nbsp;<BR>
&nbsp;<BR>
int&nbsp;myfunction()&nbsp;<BR>
{&nbsp;<BR>
...&nbsp;<BR>
}&nbsp;<BR>
&nbsp;<BR>
在v21裡可能沒問題，v22裡就不能正確執行。&nbsp;<BR>
&nbsp;<BR>
3、檢查所有用到函數指針的地方。&nbsp;<BR>
&nbsp;<BR>
v22不再支持形如(:&nbsp;ob,&nbsp;string&nbsp;:)這樣的函數指針類型，&nbsp;<BR>
&nbsp;<BR>
而需要改成：(:&nbsp;call_other,&nbsp;ob,&nbsp;string&nbsp;:)&nbsp;<BR>
比如在文件:&nbsp;/cmds/std/suicide.c&nbsp;中第44行&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;me-&gt;start_busy(&nbsp;(:&nbsp;__FILE__,&nbsp;&quot;slow_suicide&quot;,&nbsp;me&nbsp;:));&nbsp;<BR>
必須改成：&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;me-&gt;start_busy(&nbsp;(:&nbsp;call_other,&nbsp;__FILE__,&nbsp;&quot;slow_suicide&quot;,&nbsp;me&nbsp;:));&nbsp;<BR>
才能正確使用。&nbsp;<BR>
&nbsp;<BR>
類似的文件還有：&nbsp;<BR>
&nbsp;&nbsp;&nbsp;es2:&nbsp;/std/weapon/sword.c&nbsp;blade.c&nbsp;axe.c&nbsp;...&nbsp;<BR>
&nbsp;&nbsp;&nbsp;xkx:&nbsp;/inherit/weapon/sword.c&nbsp;blade.c&nbsp;axe.c&nbsp;...&nbsp;<BR>
等等。&nbsp;<BR>
&nbsp;<BR>
4、修改origin.h&nbsp;<BR>
由於v22修改了origin函數的返回類型(從int改為string),&nbsp;<BR>
所以要修改origin.h:&nbsp;<BR>
&nbsp;<BR>
#define&nbsp;ORIGIN_BACKEND&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x1&nbsp;<BR>
#define&nbsp;ORIGIN_DRIVER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x1&nbsp;<BR>
#define&nbsp;ORIGIN_LOCAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x2&nbsp;<BR>
#define&nbsp;ORIGIN_CALL_OTHER&nbsp;&nbsp;&nbsp;&nbsp;0x4&nbsp;<BR>
#define&nbsp;ORIGIN_SIMUL_EFUN&nbsp;&nbsp;&nbsp;&nbsp;0x8&nbsp;<BR>
#define&nbsp;ORIGIN_CALL_OUT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x10&nbsp;<BR>
#define&nbsp;ORIGIN_EFUN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x20&nbsp;<BR>
&nbsp;<BR>
改為：&nbsp;<BR>
&nbsp;<BR>
#define&nbsp;ORIGIN_DRIVER&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;driver&quot;&nbsp;<BR>
#define&nbsp;ORIGIN_LOCAL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;local&quot;&nbsp;<BR>
#define&nbsp;ORIGIN_CALL_OTHER&nbsp;&nbsp;&nbsp;&nbsp;&quot;call_other&quot;&nbsp;<BR>
#define&nbsp;ORIGIN_SIMUL_EFUN&nbsp;&nbsp;&nbsp;&nbsp;&quot;simul&quot;&nbsp;<BR>
#define&nbsp;ORIGIN_CALL_OUT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;call_out&quot;&nbsp;<BR>
#define&nbsp;ORIGIN_EFUN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;efun&quot;&nbsp;<BR>
&nbsp;<BR>
5、SAVE_EXTENSION宏&nbsp;<BR>
在一些ES2，XKX版本中&nbsp;/feature/save.c&nbsp;中，save_file和load_file的代碼上有&nbsp;<BR>
不同處理，其中一個加了SAVE_EXTENSION，另一個沒有SAVE_EXTENSION。這會導致&nbsp;<BR>
securityd.c中的valid_write函數判存盤文件時出問題。原則上將&nbsp;/feature/save.c&nbsp;<BR>
中的SAVE_EXTENSION去掉，然後修改securityd.c&nbsp;valid_write中判用戶存盤的一&nbsp;<BR>
段代碼改成：&nbsp;<BR>
&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Let&nbsp;user&nbsp;save&nbsp;their&nbsp;save&nbsp;file&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(&nbsp;func==&quot;save_object&quot;&nbsp;)&nbsp;{&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sscanf(file,&nbsp;&quot;/data/%*s&quot;)&nbsp;&amp;&amp;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(&nbsp;file&nbsp;==&nbsp;(string)&nbsp;user-&gt;query_save_file()&nbsp;)||&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(&nbsp;file&nbsp;==&nbsp;(string)&nbsp;user-&gt;query_save_file()&nbsp;+&nbsp;&quot;.o&quot;)&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1;&nbsp;<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<BR>
&nbsp;<BR>
6、/cmds/arch/callouts.c&nbsp;<BR>
由於V22版的call_out_info()函數作了改動，不再返回call_out的參數，也就是說&nbsp;<BR>
返回的info[i]沒有info[i][3]。因此需要改一下/cmds/arch/callouts.c，將對&nbsp;<BR>
info[i][3]的引用去掉。&nbsp;<BR>
&nbsp;<BR>
&nbsp;<BR>
&nbsp;<BR>
--&nbsp;<BR>
※&nbsp;來源:•BBS&nbsp;水木清華站&nbsp;bbs.net.tsinghua.edu.cn•[FROM:&nbsp;166.111.10.143]&nbsp;<BR>
<A HREF="00000004.htm">上一篇</A>
<A HREF='javascript:history.go(-1)'>返回上一頁</A>
<A HREF="index.htm">回到目錄</A>
<A HREF="#top">回到頁首</A>
<A HREF="00000006.htm">下一篇</A>
</H1></CENTER>
<CENTER><H1>BBS水木清華站︰精華區</H1></CENTER>
</BODY></HTML>