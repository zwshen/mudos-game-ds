// combatd.c
// #pragma optimize all
#pragma save_binary
#include <ansi.h>
#include <skill.h>
#include <weapon.h>
#include <combat.h>
// ±±¨î¸gÅç­È¥[Åv³]©w
#define MOB_RECORD_MAX 30
#define EXP_GAIN_RATE 3

inherit F_DBASE;
void delete_killer(object ob);

string *catch_hunt_msg = ({
	HIW "$N©M$n¤³¤H¬Û¨£¤À¥~²´¬õ¡M¥ß¨è¥´¤F°_¨Ó¡T\n" NOR,
	HIW "$N©M$n¤@¸I­±¡M¤G¸Ü¤£»¡´N¥´¤F°_¨Ó¡T\n" NOR,
});

string *catch_kill_msg = ({
	HIW "$N¬õµÛÂù²´¨¸´cªº¬ÝµÛ$n¡Mº¥º¥ªº©¹$n¾aªñ¡T\n" NOR,
	HIW "$N¤@¬Ý¨ì$n«K¥ß¨è½Ä¨ì$nªº¨­Ãä¡T\n" NOR,
});

string *winner_msg = ({
	CYN "\n$NÂù¤â¤@«ý¡M¯ºµÛ»¡¹D¡R©ÓÅý¡T\n\n" NOR,
	CYN "\n$N³Ó¤F³o©Û¡M¦V«áÅD¶}¤T¤Ø¡M¯º¹D¡R©ÓÅý¡T\n\n" NOR,
});

void create()
{
	seteuid(getuid());
	set("name", "¾Ô°«ºëÆF");
	set("id", "combatd");
	load_object("/adm/daemons/questd"); //¼È®É©ñ¦b³o¸Ì.
}

string damage_msg(int damage, string type)
{
	string str;

//	return "³y¦¨ " + damage + " ÂI" + type + "¡C\n";

	if( damage == 0 ) return NOR "µ²ªG¤O¹D¤Ó¤p¨Ã¨S¦³³y¦¨¶Ë®`¡C\n";

	switch( type ) {
	case "åÁ¶Ë":
	case "³Î¶Ë":
		if( damage < 10 ) str =  "µ²ªG¥u³y¦¨»´·LªºÀ¿¶Ë¡C";
		else if( damage < 20 ) str = "µ²ªG³Î¥X¤@¹D²Óªøªº¦å²ª¡C";
		else if( damage < 40 ) str = "¹º¥X¤F¤@¹D¶Ë¤f¡T";
		else if( damage < 60 ) str = "³Î¥X¤F¤@¹D¦å²O²Oªº¶Ë¤f¡T";
		else if( damage < 120 ) str = "¯d¤U¤F¤@¹D¤Sªø¤S²`ªº¶Ë¤f¡T";
		else str = "³y¦¨¤@¹D²`¤Î¨£°©ªº¥i©È¶Ë¤f¡T¡T";
		break;
	case "¨ë¶Ë":
		if( damage < 10 ) str =  "µ²ªG¥u³y¦¨»´·LªºÀ¿¶Ë¡C";
		else if( damage < 20 ) str = "µ²ªG¨ë¥X¤@­Ó¶Ë¤f¡C";
		else if( damage < 40 ) str = "µ²ªG¨ë¥X¤@­Ó¤j¶Ë¤f¡T";
		else if( damage < 60 ) str = "µ²ªG¨ë¥X¤@­Ó«Ü²`ªº¶Ë¤f¡T";
		else if( damage < 120 ) str = "µ²ªG¨ë¥X¤@­Ó¦å¦×ÁU½kªº¦å¸]ÁK¡T";
		else str = "¥uÅ¥¨£¤@ÁnºGÀz¡MÂA¦åÂq¤Fº¡¦a¡T¡T";
		break;
	case "·ï¶Ë":
		if( damage < 10 ) str =  "µ²ªG¥u³y¦¨»´·LªºÀ¿¶Ë¡C";
		else if( damage < 20 ) str = "µ²ªG³y¦¨¤@¨Ç·ï¶Ë¡C";
		else if( damage < 40 ) str = "µ²ªG³y¦¨¤£¤pªº¶Ë®`¡T";
		else if( damage < 60 ) str = "$nµh±o®tÂI­ú¤F¥X¨Ó¡T";
		else if( damage < 120 ) str = "µ²ªG$n¡u«z¡v¦a¤@Án¦R¥X¤@¤j¤fÂA¦å¡T";
		else str = "¡u¯y¡v¦a¤@Án¥¨ÅT¡M$n¤f¦RÂA¦å­¸¤F¥X¥h¡T¡T";
		break;
	default:
		if( !type ) type = "¶Ë®`";
		if( damage < 5 ) str =  "µ²ªG¥u¬O«j±j³y¦¨»´·Lªº";
		else if( damage < 10 ) str = "³y¦¨¤@ÂI";
		else if( damage < 20 ) str = "³y¦¨¤@³B";
		else if( damage < 40 ) str = "³y¦¨»á­«ªº";
		else if( damage < 60 ) str = "³y¦¨ÄY­«ªº";
		else if( damage < 90 ) str = "³y¦¨¬Û·íÄY­«ªº";
		else if( damage < 120 ) str = "³y¦¨«D±`ÄY­«ªº";
		else if( damage < 150 ) str = "³y¦¨¤£¥i®¾±Ïªº";
		else if( damage < 180 ) str = "³y¦¨µL»P­Û¤ñªºÄY­«";
		else str =  "³y¦¨Á|¥@µLÂùªº";
		str += type + "¡T";
	}
	
//	str += sprintf("(%s%d)"NOR,HIR,damage);
	return str;
}

string eff_status_msg(int ratio)
{
	if( ratio==100 ) return HIG "ºë¯««Ü¦n¡M¨­¤W¤@ÂI¶Ë¤]¨S¦³¡C" NOR;
	if( ratio > 90 ) return HIG "¦ü¥G¨ü¤FÂI»´¶Ë¡C" NOR;
	if( ratio > 80 ) return HIY "¨­¤W¦³¤@¨Ç¤p¶Ë¤f¡C" NOR;
	if( ratio > 70 ) return HIY "¨­¤W¦³´X³B¶Ë¤f¡M¤£¹L¦ü¥G¨Ã¤£Ãª¨Æ¡C" NOR;
	if( ratio > 60 ) return HIY "¨­¤W¦³´X³B¤j¶Ë¤f¡M¬Ý°_¨Óª¬ªp¤£¤Ó¦n¡C" NOR;
	if( ratio > 50 ) return HIM "®ð®§²Ê­«¡M°Ê§@´²¶Ã¡M¬Ý¨Ó¨ü³Ð¤£»´¡C" NOR;
	if( ratio > 40 ) return HIM "¤w¸g¶Ë²ª²Ö²Ö¡M¥¿¦b«j¤O¤ä¼µµÛ¤£­Ë¤U¥h¡C" NOR;
	if( ratio > 30 ) return HIR "¨ü¤F¬Û·í­«ªº¶Ë¡M¥u©È·|¦³¥Í©R¦MÀI¡C" NOR;
	if( ratio > 20 ) return HIR "¤w¸g¨ü¶Ë¹L­«¡M¦ü¥G§Ö¤£¦æ¤F¡C" NOR;
	if( ratio > 10  ) return RED "²V¨­¬O¦å¡M¤w¸g©a©a¤@®§¤F¡C" NOR;
	return RED "¤w¸g­Ë¦b¦åªy¤§¤¤¡MÀH®É³£¥i¯àÂ_®ð¡C" NOR;
}

varargs void report_status(object ob, int effective)
{
	message_vision( "( $N" + eff_status_msg(
		(int)ob->query("hp") * 100 / (int)ob->query("max_hp") ) + " )\n", ob);
}

varargs string status(object ob, int effective)
{
 return ob->name()+eff_status_msg((int)ob->query("hp") * 100 / (int)ob->query("max_hp") );
}

// This function calculates the combined skill/combat_exp power of a certain
// skill. This value is used for A/(A+B) probability use.
varargs int skill_power(object ob, string skill, int usage)
{
	int power,lvpower,i;

	int *lvpower_map = ({5000,3000,1500});	// ¼W¥[µ¥¯Åªº­«­n©Ê

	if( !living(ob) ) return 0;

	i = ob->query("level")/20;
	if( i < 0 ) i = 0;
	if( i > 2 ) i = 2;

	lvpower = lvpower_map[i];

	power = ob->query_skill(skill);

	if( ob->query("mp") < ob->query("max_mp")/10 )	//mp³Ñ¤U1/10·|´î®z
		power = power*4/5 ;

//	power += ob->query("combat_exp")/1500;
//	power += ob->query("combat_exp")/5000;
	power += ob->query("combat_exp")/lvpower;
	power /= 2;

//	write(" "+ob->query("name")+" lvpower = "+lvpower+" power = "+power+"\n");
	return power;
}

varargs int attack_factor(object ob,string attack_skill)
{
  int factor;
  factor = 0;
  if( !living(ob) ) return 0;

  factor = skill_power(ob, attack_skill, SKILL_USAGE_ATTACK);	//§Þ¯à©R¤¤­×¥¿(0-50)
  factor += ob->query_temp("apply/hit");			//ªZ¾¹©R¤¤­×¥¿(-50 ~ 50)
  factor += ob->query_temp("spell/hit");			//ªk³N©R¤¤­×¥¿(-50 ~ 50)
  factor += ob->query_dex()*2;					//dex ©R¤¤­×¥¿(0-200)
  if(ob->query_temp("detect"))
   factor += ob->query_temp("detect")*10;			//°»´ú­×¥¿
  if(ob->query("wound/hand") )
   factor= factor - (factor * ob->query("wound/hand") )/110;	//wound­×¥¿
  return factor;
}

varargs int dodge_factor(object ob,string dodge_skill)
{
  int factor;
  factor = 0;
  if( !living(ob) ) return 0;
  if( ob->query("hp") < 1) return 0;
  factor -= skill_power(ob, dodge_skill, SKILL_USAGE_DEFENSE);	//§Þ¯à°{¸ú­×¥¿(0-50)
  factor -= ob->query_dex()*2;					//dex °{¸ú­×¥¿(0-200)
  if(ob->query_temp("invis"))
   factor -= ob->query_temp("invis")*10;			//Áô¨­­×¥¿(0-100)
  if(ob->query_temp("fly")) factor -= 25;			//­¸¦æ­×¥¿(0-25)
  else if(ob->query_temp("float")) factor -= 10;		//º}¯B­×¥¿(0-10)
  if( ob->query("wound/foot") )
   factor= factor - (factor * ob->query("wound/foot") )/110;	//wound­×¥¿
  return factor;
}

//
// ¤º¦b¯À½è©Ò³y¦¨ªº¶Ë®`
//
int Merits_damage(object me,object victim,int damage,string Merits_type)
{
	int a,b,damage2;
	damage2 = damage;
	if(!(Merits_type == "bio" || Merits_type == "bar" || Merits_type == "wit"
	|| Merits_type == "sou" || Merits_type == "tec") )
		Merits_type = "bar";
	
	a = me->query_Merits(Merits_type);
	b = victim->query_Merits(Merits_type);
	damage += ( damage*( a - b ) )/5;

	if ( damage < 0 ) damage = 0;
	else if( userp(me) && userp(victim) ) damage=damage*2/3;
	if( wizardp(me) && me->query("env/debug") )
	{
		tell_object(me,HIG"©I¥s Merits_damage() !\n§ðÀ»ªÌ:["+me->query("name")+
		HIG"]³Q§ðÀ»ªÌ:["+victim->query("name")+HIG"]­ì©l¶Ë®`­È¬°("+damage2+
		")§ðÀ»ºØÃþ:("+Merits_type+")\n"+
		"¦^¶Ç¶Ë®`­È¬°:("+damage+")\n"NOR);
	}
	if( wizardp(victim) && victim->query("env/debug") )
	{
		tell_object(victim,HIY"©I¥s Merits_damage() !\n§ðÀ»ªÌ:["+me->query("name")+
		HIY"]³Q§ðÀ»ªÌ:["+victim->query("name")+HIY"]­ì©l¶Ë®`­È¬°("+damage2+
		")§ðÀ»ºØÃþ:("+Merits_type+")\n"+
		"¦^¶Ç¶Ë®`­È¬°:("+damage+")\n"NOR);
	}

	return damage;
}

// do_attack()
//
// Perform an attack action. This function is called by fight() or as an
// interface for some special utilize in quests.
//
varargs int do_attack(object me, object victim, object weapon, int attack_type)
{
	mapping my, your, action;
	string limb, *limbs, result, result_damage,result_me,result_victim;
	string attack_skill, dodge_skill, parry_skill;
	string attact_type;
	mixed foo;
	mapping weapon_msg;
	int hitrole, heavy, miss;
	int damage, damage_bonus;

	//¨ó¤O§Þ­­©w¬°»â¶¤¤~¯à©I¥s
	if(me->is_team_leader() && (me->query_temp("combine/bonus") || random(200)<me->query("level")))
	{
	 //tell_object(me,"COMBATD©I¥s combine_attack()¤¤!\n");
	 if(me->combine_attack(victim,victim->query_enemy()))
	 {
	  if(me->query_temp("combine/bonus")) me->add_temp("combine/bonus",-1); //¥²¥X¦¸¼Æ
	  return 1;
	 }
	}


  result_damage="";
  my = me->query_entire_dbase();
  your = victim->query_entire_dbase();

	//
	// (1) Find out what action the offenser will take.
	//

  action = me->query("actions");
  if( !mapp(action) )
  {
	me->reset_action();
	action = me->query("action");
	if( !mapp(action) )
	{
		CHANNEL_D->do_channel( this_object(), "sys", sprintf("%s(%s): bad action = %O",
					me->name(1), me->query("id"), me->query("actions", 1)));
		return 0;
	}
  }
  result = "" + action["action"] + "¡T";
  if(weapon)
  if(arrayp(weapon_msg=weapon->query("combat_msg"))) result=""+weapon_msg[random(sizeof(weapon_msg))]+ "¡T";
	//
	// (2) ªì©l¾÷²v¨Ã¥[¥H­×¥¿¥H§PÂ_¬O§_¯à©R¤¤
	//
  heavy=0;
  miss=0;	
  hitrole=random(HITROLE);			// random¼Æ¦r¶V§C ÄÝ©Ê§Þ¯à¼vÅT¶V¤j

  if(attack_type == TYPE_HEAVY) heavy=1;
  else if(hitrole > HITHEAVY ) heavy=1; 		//heavy ©R¤¤­n®`
	else if(hitrole < HITMISS && attack_type!=TYPE_BERSERK) miss=1;		//miss  ÄY­«¥¢¤â

  if( wizardp(me) && me->query("env/debug") )	//debug message 1
  message_vision("  ªì©l©R¤¤¾÷²v:"+hitrole+"\n",me);

  if( objectp(weapon) )	attack_skill = weapon->query("skill_type");
	else		attack_skill = "unarmed";

  limbs = victim->query("limbs");
  limb = limbs[random(sizeof(limbs))];

  hitrole += attack_factor(me,attack_skill);

  hitrole += dodge_factor(victim,"dodge");

  if(attack_type==TYPE_BERSERK) hitrole-=hitrole/20; 	//Berserk ¦h¦¸§ðÀ»­°§C©R¤¤²v
  else if(attack_type==TYPE_QUICK) hitrole+=hitrole/10; //Quick §Ö³t§ðÀ»¼W¥[©R¤¤²v

  if( wizardp(me) && me->query("env/debug") )		//debug message 2
  message_vision("  ©R¤¤­×¥¿:"+attack_factor(me,attack_skill)
  +"  °{¸ú­×¥¿:"+dodge_factor(victim,"dodge")+"\n"
  +"  §ðÀ»TYPE­×¥¿µ²ªG:"+hitrole+"\n"
  ,me);
 
  if( victim->is_busy() ) hitrole+=hitrole/5;

	//
	// (3) Fight!
	//     ¦pªGhitrole > 150 §Y¬°©R¤¤, <150 «h¨S¦³©R¤¤
	//     ·íheavy==1 ®É¥²©w©R¤¤, ¦Ómiss==1®É ¥²©w¥¢¤â¥B·|¦]¬°¥¢»~¦Ó³y¦¨busy
	//
  if( ( !heavy && ( hitrole < THACO ) && !victim->query_temp("unconcious") ) || miss )  // victim°{¸ú¦¨¥\
  {
	dodge_skill = victim->query_skill_mapped("dodge");
	if( !dodge_skill ) dodge_skill = "dodge";
	result += SKILL_D(dodge_skill)->query_dodge_msg(limb);
	
	//¼W¥[¸gÅç­È»P§Þ¯à
	if( ( random(your["level"] + my["level"]) >= your["level"] ) && ( !userp(victim) || !userp(me) ) )
	{
		if( (my["level"]>2 && your["level"]>2) || (my["exp"]*999 > your["exp"] )) //­­¨î§Cµ¥¯Å¨g½m¥\«o¤£¤É¯Å
		{
			if( victim->query("int") > random(180) && ( your["level"]>4 || your["combat_exp"]<your["level"]*3000))// ¼W¥[combat_expªº§xÃø«×
				your["combat_exp"] += 1+my["level"]/25;
			victim->improve_skill(dodge_skill, random( your["int"]/4 +my["level"]/3) + 1 );
			if( dodge_skill != "dodge" )
			victim->improve_skill("dodge", random( your["int"]/4+my["level"]/3 ) + 1 );
		}
	}
	
	// This is for NPC only. NPC have chance to get exp when fail to hit.
	if( ( hitrole > EXPCO ) && !userp(me) )
	{
		if( me->query("int") > random(180) && ( my["level"]>4 || my["combat_exp"]<my["level"]*3000) )// ¼W¥[combat_expªº§xÃø«×
			my["combat_exp"] += 1+your["level"]/25;
		me->improve_skill(attack_skill, 1+random(my["int"]/4+your["level"]/3));
	}
	if(miss && !me->is_busy()) me->start_busy(random(2)+1);
	damage = RESULT_DODGE;

  } else	//victim°{¸ú¥¢±Ñ
    {
		//
		//	(4) ÀË¬dvictim¬O§_¯à©Û¬[§ðÀ»
		//
	// ·í¹ï¤â¦P®É®³ªZ¾¹¤Î¬ÞµP®É, ¥Î¶Ã¼Æ¨M©w©Û¬[ªººØÃþ by Shengsan
	if( objectp(victim->query_temp("armor/shield")) && objectp(victim->query_temp("weapon")) )
	{
		parry_skill = (random(50)%2>0) ? "block" : "parry" ;
	}
	else if( objectp(victim->query_temp("armor/shield")) )	//¹ï¤â¦³¬ÞµP
	{
		parry_skill = "block";
	}
	else
	{
	  if( objectp(victim->query_temp("weapon")) )	//¹ï¤â¦³ªZ¾¹
	  {
		parry_skill = "parry";
	  }
	   else	//¹ï¤â¨S¦³ªZ¾¹
	   {
		parry_skill = "unarmed";
	   }
	}
	
	hitrole = random(HITROLE);
	if( parry_skill == "unarmed" )
		hitrole -= skill_power(victim, parry_skill, SKILL_USAGE_DEFENSE)/2;
	else
		hitrole -= skill_power(victim, parry_skill, SKILL_USAGE_DEFENSE);
	hitrole += skill_power(me, attack_skill, SKILL_USAGE_ATTACK);
	hitrole -= victim->query_temp("apply/parry");
	hitrole += me->query_str()*3;
	hitrole -= victim->query_str()*3;
	if( victim->is_busy() )  hitrole+= hitrole/5;

	//victim©Û¬[¦¨¥\

	if( ( !heavy && ( hitrole < THACO ) && !victim->query_temp("unconcious") ) || miss )
	{
			// change to SKILL_D(parry_skill) after added parry msg to those
			// martial arts that can parry.

		if(parry_skill=="block")
		result += SKILL_D("block")->query_block_msg(victim->query_temp("armor/shield"));	
		else
		result += SKILL_D("parry")->query_parry_msg(victim->query_temp("weapon"));	//©Û¬[°T®§

		if( ( random(your["level"]-my["level"]) < random(2) ) && ( !userp(victim) || !userp(me) ) )
		{
				if( victim->query("int") > random(180) && ( your["level"]>4 || your["combat_exp"]<your["level"]*3000))// ¼W¥[combat_expªº§xÃø«×
					your["combat_exp"] += 1+my["level"]/25;
				victim->improve_skill(parry_skill, 1+random(your["int"]/4+my["level"]/3));
		}
		
		damage = RESULT_PARRY;

	}
	 else
	  {
			//	
			//	(5) ©R¤¤¼Ä¤Hvictim¥Bvictim©Û¬[¥¢±Ñ, ¶}©l­pºâ¶Ë®`­È
			//
		damage = me->query_damage();
		damage = damage/2 + random(damage/2);
		
		if( action["damage"] )
		{
			if(action["damage"]>100) action["damage"]=100;
			if(action["damage"]<-99) action["damage"]=-99;
			damage += action["damage"] * damage / 100;	//skill®ÄªG­×¥¿[]%
		}

		if( weapon )
		{
			foo = weapon->hit_ob(me, victim, damage_bonus);
			if( stringp(foo) ) result += foo;
			else if(intp(foo) ) damage_bonus += foo;
		}
		 else
		  {
			foo = me->hit_ob(me, victim, damage_bonus);
			if( stringp(foo) ) result += foo;
			else if(intp(foo) ) damage_bonus += foo;
		  }

		if( damage_bonus > 0 )
			damage += (damage_bonus + random(damage_bonus))/2;

			//
			//	(6) µ¹¤©¼Ä¤H¶Ë®`
			//
		damage -= (int)(victim->query_armor()*3+random(victim->query_armor()*2))/5;
		if(heavy) damage+=damage/2;

			//	¤º¦b¯À½è¹ï¶Ë®`­Èªº¼vÅT
		if(!action["attact_type"] ) attact_type = "bar";
		else attact_type = action["attact_type"];
		damage = Merits_damage(me,victim,damage,attact_type);
		if(damage <0 )
		{
		 if(random(me->query_str()+1) < victim->query_str()/2 && random(14)>1) damage=0;
		 else damage=1+random(me->query_str())/3;
		}
		
		if(damage > 0 )
		{
		 damage = victim->receive_damage("hp", damage, me );
		}
		 result_damage +=damage_msg(damage, action["damage_type"]);

	}
  } 
  
  	//
	//	(7) ¼W¥[¾Ô°«¼ô½m­È»P§Þ¯à
	//
	if( !userp(me) || !userp(victim) )
	{
		if( random(your["level"] + my["level"] + 3) >= my["level"] )
		{
			if( me->query("int") > random(180) && ( my["level"]>4 || my["combat_exp"]<my["level"]*3000))// ¼W¥[combat_expªº§xÃø«×
				my["combat_exp"] += 1 + your["level"]/25;
			if(random(4)<1 && my["exp"]<my["level"]*500000) //±±¨î¼W¥[expªº¾÷²v
			my["exp"] += random(1+your["level"]/2-my["level"]/4)+random(2); //±±¨î¼W¥[expªº¶q
			me->improve_skill("combat", 1+random(my["int"]/4+my["level"]/3+your["level"]/3));
			me->improve_skill(attack_skill, 1 + random(my["int"]/4+my["level"]/3+your["level"]/3));
			if(me->query_skill_mapped(attack_skill))
			me->improve_skill(me->query_skill_mapped(attack_skill), 1+random(my["int"]/4+my["level"]/3+your["level"]/3));
		}
	
		if( random(your["level"] + my["level"] + 3) >= your["level"] )
		{
			if( (my["level"]>2 || your["level"]>2) || (my["exp"]*9999 > your["exp"] )) //­­¨î§Cµ¥¯Å¨g½m¥\«o¤£¤É¯Å
			{
				if( victim->query("int") > random(180) && ( your["level"]>4 || your["combat_exp"]<your["level"]*3000) )// ¼W¥[combat_expªº§xÃø«×
					your["combat_exp"] += 1 + my["level"]/25;
				victim->improve_skill("combat", 1+random(your["int"]/4+your["level"]/3+my["level"]/3));
			}
		}
	}
  
  //
  //	(8) Åã¥Ü¾Ô°«°T®§
  //
  if(heavy) result = HIM+"(¾Ä¤O¤@À»)"+NOR+result;
  else if(miss) result = HIM+"(­«¤ß¤£Ã­)"+NOR+result;
  result = replace_string( result, "$l", limb );
  result_damage = replace_string( result_damage, "$l", limb );
  if( objectp(weapon) )
  {
	result = replace_string( result, "$w", weapon->name() );
        result_damage = replace_string( result_damage, "$w", weapon->name() );
  }
  else if( stringp(action["weapon"]) )
  {
	result = replace_string( result, "$w", action["weapon"] );
	result_damage = replace_string( result_damage, "$w", action["weapon"] );
  }
  result_me=result+HIY+result_damage+NOR;

  result_me = replace_string( result_me, "$N", "§A" );
  result_me = replace_string( result_me, "$n", victim->query("name") );
  result_me = replace_string( result_me, "$p", victim->query("name") );
  result_victim=result+HIR+result_damage+NOR;
  result_victim = replace_string( result_victim, "$N", me->query("name") );
  result_victim = replace_string( result_victim, "$n", "§A" );
  result_victim = replace_string( result_victim, "$p", "§A" );
  if(damage>0)
  {
   if(me->query_temp("show_damage")
    || me->query_temp("apply/show_damage") ) result_me+=sprintf("(%s%d"NOR")\n",HIY,damage);
 	else result_me+="\n";
   if(victim->query_temp("show_damage")
    || victim->query_temp("apply/show_damage")  ) result_victim+=sprintf("(%s%d"NOR") (%d/%d)\n",HIR,damage,your["hp"],your["max_hp"]);
	else result_victim+="\n";
  }
  //message_vision(result, me, victim );
  if( wizardp(me) && me->query("env/debug") )
  {
		tell_object(me, sprintf( HIG "  §Ú¤è©R¤¤!!(HITROLE¡R%d) ¡M¼Ä¤è¨ü¶Ë¡R%d\n" NOR,
			hitrole, damage));
  }
  if( wizardp(victim) && victim->query("env/debug") )
  {
		tell_object(victim, sprintf( HIY "  ¼Ä¤è©R¤¤!!(HITROLE¡R%d)¡M§Ú¤è¨ü¶Ë¡R%d\n" NOR,
			hitrole, damage));
  }
  tell_object(me,result_me);
  tell_object(victim,result_victim+"\n");
  result+=CYN+result_damage+NOR+"\n";
  result = replace_string( result, "$N", me->query("name")  );
  result = replace_string( result, "$n", victim->query("name") );
  result = replace_string( result, "$p", victim->query("name") );
  tell_room(environment(me),result,({ me, victim }));


  if( damage > 0 )
  {
	if(me->query("env/report")) report_status(victim, damage);	//set report 1 ¥i¥H¬Ý¨ìreport
	if( victim->is_busy() ) victim->interrupt_me(me);
	if( (!me->is_killing(your["id"])) && (!victim->is_killing(my["id"])) )	//only fight
	{
	  if( victim->query("hp") < victim->query("max_hp")/2 )	//¥´¨ì³Ñ¤U 1/2 HP §Y°±¾Ô
	  {
		victim->remove_enemy(me);
		me->remove_enemy(victim);
		me->set_temp("stop_fight",victim);
		message_vision( winner_msg[random(sizeof(winner_msg))], me, victim);
	  }
	}
	if( damage > victim->query("max_hp")/7 )
	{
	 damage_bonus = random(13);
	 switch(damage_bonus)
	 {
	  case 1 :	victim->receive_wound("head", random(7), me );
	 		break;
	  case 2 :	victim->receive_wound("hand", random(7), me );
	 		break;
	  case 3 :	victim->receive_wound("foot", random(7), me );
	 		break;
	  case 4 :	victim->receive_wound("body", random(7), me );
	 		break;
	  default:      break;
	 }
	}
  }

  if( functionp(action["post_action"]) )
	evaluate( action["post_action"], me, victim, weapon, damage);

	// See if the victim can make a riposte.

  if( attack_type==TYPE_REGULAR && damage < 1 && random(20) < 2)
  {
	if( random(your["dex"]) > random(my["dex"]) )
	{
		message_vision("$N¤@À»¤£¤¤¡MÅS¥X¤F¯}ºì¡T\n", me);
		do_attack(victim, me, victim->query_temp("weapon"), TYPE_QUICK);
	}
	 else
	  {
		message_vision("$N¨£$n§ðÀ»¥¢»~¡M¶X¾÷µo°Ê§ðÀ»¡T\n", victim, me);
		do_attack(victim, me, victim->query_temp("weapon"), TYPE_RIPOSTE);
	  }
  } 
}


void fight(object me, object victim)
{
        object ob,weapon;

        if( !living(me) ) return;
        
        if(victim->query_temp("stop_fight")==me)
        {
         victim->delete_temp("stop_fight");
         me->remove_enemy(victim);
         return;
        }
        // If victim is busy or unconcious, always take the chance to make an attack.
        if( victim->is_busy()) 
        //|| !living(victim)  
        {
                me->set_temp("guarding", 0);
                do_attack(me, victim, me->query_temp("weapon"), TYPE_QUICK);

        // Else, see if we are brave enough to make an aggressive action.
	}
 	else
 	if(me->query_temp("power_cast") < 1 && me->query_temp("power_exert") < 1)
 	{
        	me->set_temp("guarding", 0);
        	do_attack(me, victim, me->query_temp("weapon"), TYPE_REGULAR);
        	if(weapon=me->query_temp("weapon"))
        		weapon->attack(me,victim);
        } else return;

        // Make sure the victim had noticed the attack.
        if( !victim->is_fighting(me) ) victim->fight_ob(me);
}
//	auto_fight()
//
//	This function is to start an automatically fight. Currently this is
//	used in "aggressive", "vendetta", "hatred", "berserk" fight.
//
void auto_fight(object me, object obj, string type)
{
	// Don't let NPC autofight NPC.
	if( !userp(me) && !userp(obj) ) return;

	// Because most of the cases that we cannot start a fight cannot be checked
	// before we really call the kill_ob(), so we just make sure we have no 
	// aggressive callout wating here.
	if( me->query_temp("looking_for_trouble") ) return;
	me->set_temp("looking_for_trouble", 1);

	// This call_out gives victim a chance to slip trough the fierce guys.
	call_out( "start_" + type, 0, me, obj);
}

void start_berserk(object me, object obj)
{
	int bellicosity;

	if( !me || !obj ) return;			// Are we still exist( not becoming a corpse )?

	me->set_temp("looking_for_trouble", 0);

	if(	me->is_fighting(obj)			// Are we busy fighting?
	||	!living(me)				// Are we capable for a fight?
	||	environment(me)!=environment(obj)	// Are we still in the same room?
	||	environment(me)->query("no_fight") 	// Are we in a peace room?
	)	return;

	bellicosity = (int)me->query("bellicosity");
	message_vision("$N¥Î¤@ºØ²§¼Ëªº²´¯«±½µøµÛ¦b³õªº¨C¤@­Ó¤H¡C\n", me);

	if(	(int)me->query("force") > (random(bellicosity) + bellicosity)/2 ) return;

	if( bellicosity > (int)me->query("score") 
	&&	!wizardp(obj) ) {
		message_vision("$N¹ïµÛ$n³Ü¹D¡R" + RANK_D->query_self_rude(me)
			+ "¬Ý§A¹ê¦b«Ü¤£¶¶²´¡M¥h¦º§a¡C\n", me, obj);
		me->kill_ob(obj);
	} else {
		message_vision("$N¹ïµÛ$n³Ü¹D¡R³Þ¡T" + RANK_D->query_rude(obj)
			+ "¡M" + RANK_D->query_self_rude(me) + "¥¿·Q§ä¤H¥´¬[¡M³­§Úª±¨â¤â§a¡T\n",
			me, obj);
		me->fight_ob(obj);
	}
}

void start_hatred(object me, object obj)
{
	if( !me || !obj ) return;			// Are we still exist( not becoming a corpse )?

	me->set_temp("looking_for_trouble", 0);

	if(	me->is_fighting(obj)			// Are we busy fighting?
	||	!living(me)				// Are we capable for a fight?
	||	environment(me)!=environment(obj)	// Are we still in the same room?
	||	environment(me)->query("no_fight") 	// Are we in a peace room?
	)	return;

	// We found our hatred! Charge!
	message_vision( catch_hunt_msg[random(sizeof(catch_hunt_msg))], me, obj);
	me->kill_ob(obj);
}

void start_vendetta(object me, object obj)
{
	if( !me || !obj ) return;			// Are we still exist( not becoming a corpse )?

	me->set_temp("looking_for_trouble", 0);

	if(	me->is_fighting(obj)			// Are we busy fighting?
	||	!living(me)				// Are we capable for a fight?
	||	environment(me)!=environment(obj)	// Are we still in the same room?
	||	environment(me)->query("no_fight") 	// Are we in a peace room?
	)	return;

	// We found our vendetta opponent! Charge!
	me->kill_ob(obj);
}

void start_aggressive(object me, object obj)
{
	if( !me || !obj ) return;			// Are we still exist( not becoming a corpse )?

	me->set_temp("looking_for_trouble", 0);

	if(	me->is_fighting(obj)			// Are we busy fighting?
	||	!living(me)				// Are we capable for a fight?
	||	environment(me)!=environment(obj)	// Are we still in the same room?
	||	environment(me)->query("no_fight") 	// Are we in a peace room?
	)	return;

	// We got a nice victim! Kill him/her/it!!!
	me->kill_ob(obj);
}

void start_killer(object me, object obj)
{
	if( !me || !obj ) return;			// Are we still exist( not becoming a corpse )?

	me->set_temp("looking_for_trouble", 0);

	if(	me->is_fighting(obj)			// Are we busy fighting?
	||	!living(me)				// Are we capable for a fight?
	||	environment(me)!=environment(obj)	// Are we still in the same room?
	||	environment(me)->query("no_fight") 	// Are we in a peace room?
	)	return;

	// We got a nice victim! Kill him/her/it!!!
	message_vision( catch_kill_msg[random(sizeof(catch_kill_msg))], me, obj);
	me->set_leader(obj);
	me->kill_ob(obj);
}

// This function is to announce the special events of the combat.
// This should be moved to another daemon in the future.
void announce(object ob, string event)
{
	switch(event)
	{
		case "dead":
			message_vision("\n  $NÅu­Ë¦b¦a¤W, ©âÝf¤F´X¤U...¡C\n\n  $N¦º¤F¡C\n\n", ob);
			break;
		case "unconcious":
			message_vision("\n  $N¸}¤U¤@­Ó¤£Ã­, ©ü­Ë¦b¦a¤W, ®ð®§¶V¨Ó¶V·L®z¤F¡C\n\n", ob);
			ob->set_temp("unconcious",1);
			break;
		case "revive":
            message_vision("\n$NºCºC¸C¶}²´·ú¡M²M¿ô¤F¹L¨Ó¡C\n\n", ob);
			ob->delete_temp("unconcious");
			break;
	}
}

void winner_reward(object killer, object victim)
{
	killer->defeated_enemy(victim);
}

void killer_reward(object killer, object victim )
{
	object *team;
	int i,bls,victim_exp,k=0,max_record,exp_rate,gain_exp,num1,num2,num3,nums;
	string vmark,mob_file,*mob_record;

	// Call the mudlib killer apply.
	killer->killed_enemy(victim);
	victim_exp=victim->query("exp");
//¤U­±ÀË¬d³Q±þªÌ¬O§_¬°ª±®a
	if( userp(victim) && !wizardp(victim))
	{
		if(userp(killer) && !victim->query_temp("killer"))
		{
		 killer->add_temp("killer",1);
		 call_out("delete_killer", 1200, killer );
		}

		killer->add("PKS", 1);
		victim->clear_condition();
		
		// Give the death penalty to the dying user.
		victim->set("bellicosity", 0);
		victim->add("combat_exp", -(int)victim->query("combat_exp") / 10);
		victim->add("exp", -victim_exp / 10);
		gain_exp=victim_exp/15+random(10);
		killer->add("exp", gain_exp);
		tell_object(killer,"  §A±o¨ì "+gain_exp+" ÂI¸gÅç­È!\n" );
		victim->delete("vendetta");
		
		if( victim->query("thief") ) victim->set("thief", (int)victim->query("thief") / 2);
		if( victim->query_temp("killer") ) victim->add_temp("killer", -1);

//		if( (int)victim->query("potential") > (int)victim->query("learned_points"))
//			victim->add("potential",
//				((int)victim->query("learned_points") - (int)victim->query("potential"))/2 );
		
		victim->skill_death_penalty();
		victim->save();
		bls = 1;
		
		if( userp(killer) )		//PK°T®§
		{
		 CHANNEL_D->do_channel(this_object(), "rumor",
			sprintf(RED"¥i¼¦ªº%s¤£©¯³à©R©ó±þ¤H¨g -%s- ªº¤â¤W¡C", victim->name(1), killer->name(1)));
		}
		 else CHANNEL_D->do_channel(this_object(), "rumor",
			sprintf(RED"%s"RED"³Q%s"RED"±þ¦º¤F¡C", victim->name(1), killer->name(1)));
	} 
	 else
	  {
		killer->add("MKS", 1);
		bls = 1;
	  }

	// NPC got 10 times of bellicosity than user.
//	killer->add("bellicosity", bls * (userp(killer)? 1: 10));	//¼W¥[±þ®ð

	if( stringp(vmark = victim->query("vendetta_mark")) )
	killer->add("vendetta/" + vmark, 1);
	if(userp(killer))
	{
		if( killer->query("evil") <999 && killer->query("evil") > -999 ) //°}ÀçÅÜ´«
		{
		  if( victim->query("evil") > 0 || victim->query("evil") < 0 )	
	  	  {
		 	killer->add("evil",-victim->query("evil")/3);
	  	  }
		}
		
		//±þ¦ºmob
		if(!userp(victim) || !wizardp(victim))
		{
		/* ¥[¤Jmob¬ö¿ý¥H«K³B²zexp¥[Åv­pºâ, ¨¾¤îrobot */
		   mob_record=killer->query("mob_record");
		   mob_file=base_name(victim);
		   max_record=MOB_RECORD_MAX;
		   exp_rate=EXP_GAIN_RATE;

		   if(sizeof(mob_record)>0)
		   {
			if(sizeof(mob_record)>=max_record) mob_record=mob_record[0..(max_record-2)];
		   	mob_record=({mob_file})+mob_record;
		   } else mob_record=({mob_file});
		   
		   killer->set("mob_record",mob_record);
		  
		   if(victim->query("level") > 3 && killer->query("level") > 3)
		   {
		   	for(i=0;i<sizeof(mob_record) && i<max_record;i++)
		   	{
		   		if(mob_record[i]==mob_file) k++;
		   	}
			if(k <= exp_rate*2) k=1+k/exp_rate;
		    	if( k < 1) k=1;
		        else if( k >10) k=10;
		   } else k=1;
		   
		  if(team=killer->query_team())
		  {
		  	killer->team_reward(victim,victim->query_enemy(),k);
		  } else
		  {
		   gain_exp=victim_exp/k+random(20);
		   killer->add("exp", gain_exp);
		   tell_object(killer,"  §A±o¨ì "+gain_exp+" ÂI¸gÅç­È!\n" );
		   if(gain_exp>100)
		   {
		   	if(gain_exp%1000==777)
		   	{
		   		tell_object(killer,HIW"  ®¥³ß!! ±z¤¤¤F[1;5;31m¢¶¢¶¢¶[0m"HIW"¯S§O¼ú!!\n"HIG"  §A±o¨ìÃB¥~ªº "+gain_exp*2+" ÂI¸gÅç­È!\n"NOR );
		   		killer->add("exp", gain_exp*2);
		   	}
		    	else
		   	{
		   		nums=gain_exp%1000; //¨ú¥½¤T¦ì
		   		//num1=nums/100; //²Ä¤@¦ì¼Æ¦r
		   		//num2=(nums%100)/10; //²Ä¤G¦ì
		   		//num3=nums%10;
		     		switch(nums)
		     		{
		     		 case 123:
		     		 case 234:
		     		 case 345:
		     		 case 456:
		     		 case 567:
		     		 case 678:
		     		 case 789:  
		     		 		tell_object(killer,HIW"  ®¥³ß!! ±z¤¤¤F[1;5;36m¦Pªá¶¶[0m"HIW"¯S§O¼ú!!\n"HIG"  §A±o¨ìÃB¥~ªº "+gain_exp+" ÂI¸gÅç­È!\n"NOR );
		   				killer->add("exp", gain_exp);
		     		 default: break;
		     		}
		   	}
		   }
		  }
		}
	
		
		if(!userp(victim) && victim->query("war_score"))
		{
		 killer->add("war_score",victim->query("war_score"));
		 tell_object(killer,HIW"  §A±o¨ì¤@¨Ç¾Ô¥\\!\n"NOR);
		}
		killer->save();   	
	}
}



void delete_killer(object killer)
{
 if(!killer) return ;
 if( killer->query_temp("killer") > 0 )
 {
 	killer->add_temp("killer",-1);
	call_out("delete_killer", 1200, killer );
 }
 return ;
}

